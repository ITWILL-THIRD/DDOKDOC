<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.todoc.hospital.dao.HospitalDAO">
	<!-- 병원 정보 1개 조회 -->
	<select id="selectOne" parameterType="int" resultType="HospitalVO">
		SELECT *
		FROM HOSPITAL H, HOSTIME HT, HOSADDRESS HA
		WHERE H.HOSIDX = HT.HOSIDX
		AND H.HOSIDX = HA.HOSIDX
		AND H.HOSIDX = #{hosIdx}
	</select>
	
	<!-- 병원 전체 조회 -->
	<select id="selectList" resultType="HospitalVO">
		SELECT *
		FROM HOSPITAL H, HOSTIME HT, HOSADDRESS HA
		WHERE H.HOSIDX = HT.HOSIDX
		AND H.HOSIDX = HA.HOSIDX
		ORDER BY H.HOSIDX DESC
	</select>
	
	<!-- 병원 리뷰 조회 -->
	<select id="getHosReview" parameterType="int" resultType="HosReviewVO">
	    SELECT R.*, U.NICKNAME AS NICKNAME 
		FROM HOSREVIEW R, DDOKUSER U
		WHERE R.USERIDX = U.USERIDX 
		AND HOSIDX = #{hosIdx}
		ORDER BY HOSIDX DESC
	</select>
	
  	<!-- 동적처리(병원 정보 조회) -->
	<select id="getHosSearch" resultType="HospitalVO">
	    SELECT *
	    FROM HOSPITAL H
	    JOIN HOSADDRESS A ON A.HOSIDX = H.HOSIDX
	    JOIN HOSTIME T ON T.HOSIDX = H.HOSIDX
	    <where>
	        <choose>
	        	<when test='searchCondition == "all"'>
	        		1=1
	        	</when>
	            <when test='searchCondition == "search" and searchKeyword != "" '>
	                AND (
				        H.HOSNAME LIKE '%' || #{searchKeyword} || '%'
				        OR A.ADDRESSNAME LIKE '%' || #{searchKeyword} || '%'
				        OR A.ROADADDRESSNAME LIKE '%' || #{searchKeyword} || '%'
				        OR ANIMAL LIKE '%' || #{searchKeyword} || '%'
				    )
	            </when>
	            <when test='searchCondition == "address"'>
	        		AND A.SIDO LIKE '%' || #{sido} || '%'
					AND A.SIGUNGU LIKE '%' || #{sigungu} || '%'
	        	</when>
	            <when test='searchCondition == "addressName" and searchKeyword != "" '>
	                AND (A.ADDRESSNAME LIKE '%' || #{searchKeyword} || '%'
	                OR A.ROADADDRESSNAME LIKE '%' || #{searchKeyword} || '%')
	            </when>
	            <when test='searchCondition == "common"'>
	                AND ANIMAL = '일반'
	            </when>
	            <when test='searchCondition == "special"'>
	                AND ANIMAL = '특수'
				</when>
 	            <when test='searchCondition == "night"'>
 	            	<![CDATA[
	                AND TO_CHAR(T.CLOSETIME, 'HH24:MI:SS') > '18:00:00'
	                AND TO_CHAR(T.CLOSETIME, 'HH24:MI:SS') <= '23:59:59'
	                AND TO_CHAR(T.OPENTIME, 'HH24:MI:SS') != '00:00:00'
	             	]]>
	            </when>
	            <when test='searchCondition == "24h"'>
	                AND TO_CHAR(T.OPENTIME, 'HH24:MI:SS') = '00:00:00'
	                AND TO_CHAR(T.CLOSETIME, 'HH24:MI:SS') = '23:59:59'
	            </when>
	        </choose>
	    </where>
	    ORDER BY H.HOSIDX DESC
	</select>
	
 	<insert id="insertReview" parameterType="HosReviewVO">
		INSERT INTO HOSREVIEW(REVIEWIDX, HOSIDX, USERIDX, CONTENT, SCORE, REVIEWDATE) 
		VALUES((SELECT NVL(MAX(REVIEWIDX), 0) + 1 FROM HOSREVIEW), 
				#{hosIdx}, #{userIdx}, #{content}, #{score}, SYSDATE)
	</insert>
	
	<update id="updateReview" parameterType="HosReviewVO">
		UPDATE HOSREVIEW 
		SET CONTENT = #{content}, SCORE = #{score}, REVIEWDATE = SYSDATE 
		WHERE REVIEWIDX = #{reviewIdx}
	</update>
	
	
</mapper>